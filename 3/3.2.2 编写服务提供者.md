# 3.2.2 编写服务提供者

下面我们来编写一个服务提供者（用户微服务），该服务具备通过主键查询用户信息的能力。

为便于测试，我们使用spring-data-jpa作为持久层框架；使用h2嵌入式数据库引擎作为数据库。Spring Boot对h2数据库的支持非常棒，只需要将建表语句和DML语句放置在项目的classpath下，就能使用了。

我们首先准备好建表语句：在classpath下建立schema.sql，并加入如下内容：

```sql
drop table user if exists;
create table user (id bigint generated by default as identity, username varchar(40), name varchar(20), age int(3), balance decimal(10,2), primary key (id));
```

准备几条数据：在classpath下建立文件data.sql，并加入如下内容：

```sql
insert into user (id, username, name, age, balance) values (1,'account1', '张三',20, 100.00);
insert into user (id, username, name, age, balance) values (2,'account2', '李四',28, 180.00);
insert into user (id, username, name, age, balance) values (3,'account3', '王五',32, 280.00);
```

创建一个Maven工程，并在pom.xml文件添加如下内容：

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <artifactId>microservice-simple-provider-user</artifactId>
  <packaging>jar</packaging>

  <parent>
    <groupId>com.itmuch.cloud</groupId>
    <artifactId>spring-cloud-microservice-study</artifactId>
    <version>0.0.1-SNAPSHOT</version>
  </parent>

  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
      <groupId>com.h2database</groupId>
      <artifactId>h2</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
  </dependencies>
</project>
```

实体类：

```java
@Entity
public class User {
  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private Long id;
  @Column
  private String username;
  @Column
  private String name;
  @Column
  private Integer age;
  @Column
  private BigDecimal balance;
  ...
  // getters and stters
}
```

持久层：

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
}
```

Controller：

```java
@RestController
public class UserController {
  @Autowired
  private UserRepository userRepository;

  @GetMapping("/{id}")
  public User findById(@PathVariable Long id) {
    User findOne = this.userRepository.findOne(id);
    return findOne;
  }
}
```

启动类：

```java
@SpringBootApplication
public class ProviderUserApplication {
  public static void main(String[] args) {
    SpringApplication.run(ProviderUserApplication.class, args);
  }
}
```

配置文件：application.yml

```yaml
server:
  port: 7900
spring:
  jpa:
    generate-ddl: false
    show-sql: true
    hibernate:
      ddl-auto: none
  datasource:                           # 指定数据源
    platform: h2                        # 指定数据源类型
    schema: classpath:schema.sql        # 指定h2数据库的建表脚本
    data: classpath:data.sql            # 指定h2数据库的insert脚本
logging:
  level:
    root: INFO
    org.hibernate: INFO
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.hibernate.type.descriptor.sql.BasicExtractor: TRACE
    com.itmuch.youran.persistence: ERROR
```

这样的代码，对于接触过Spring Boot的读者来说，应该是非常简单的；对于Spring Boot新手应该也能理解其中的含义，笔者就不赘述了。




## 测试

访问：[http://localhost:7900/1](http://localhost:7900/1) ，获得结果：

```json
{
    "id": 1,
    "username": "account1",
    "name": "张三",
    "age": 20,
    "balance": 100
}
```

结果正常，我们的用户微服务已经可以提供通过主键查询用户信息的能力了。



## TIPS

* 代码中用到了`@GetMapping("/{id}")` 注解，这是一个组合注解，我们可以简单地理解为等价于`@RequestMapping(value = "/id", method = RequestMethod.GET)` ，这个注解是Spring 4.3以后提供的，用于简化我们的开发。同理还有`@PostMapping` 、`@PutMapping` 、`@DeleteMapping` 、`@PatchMapping` 等注解。
* 本书中的配置文件采用的是yml的方式，yml有严格的缩进，请大家注意。Spring Cloud同样也支持使用properties作为配置文件。yml相对properties的配置方式，更易读、更易维护。