# 2.1 服务发现

## 关于服务发现

在微服务架构中，服务发现（Service Discovery）是关键原则之一。手动配置每个客户端或某种形式的约定是很难做的，并且很脆弱。Spring Cloud提供了多种服务发现的实现方式，例如：Eureka、Consul、Zookeeper。本文暂时只讲述基于Eureka的服务发现。后续会补上基于Consul和Zookeeper的服务发现。




## Eureka Server示例

1.  首先创建一个Maven工程（microservice-discovery-eureka），并在pom.xml中加入如下内容：

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
      <modelVersion>4.0.0</modelVersion>

      <artifactId>microservice-discovery-eureka</artifactId>
      <packaging>jar</packaging>

      <parent>
        <groupId>com.itmuch.cloud</groupId>
        <artifactId>spring-cloud-microservice-study</artifactId>
        <version>0.0.1-SNAPSHOT</version>
      </parent>

      <dependencies>
        <dependency>
          <groupId>org.springframework.cloud</groupId>
          <artifactId>spring-cloud-starter-eureka-server</artifactId>
        </dependency>
      </dependencies>
    </project>
    ```

2.  编写Spring Boot启动程序：通过@EnableEurekaServer申明一个注册中心

    ```java
        /**
    * 使用Eureka做服务发现.
    * @author eacdy
    */
    @SpringBootApplication
    @EnableEurekaServer
    public class EurekaApplication {
     public static void main(String[] args) {
       SpringApplication.run(EurekaApplication.class, args);
     }
    }
    ```
   ```

3. 在默认情况下，Eureka会将自己也作为客户端尝试注册，所以在单机模式下，我们需要禁止该行为，只需要在application.yml中如下配置：

   ```yaml
   server:
     port: 8761                    # 指定该Eureka实例的端口

   eureka:
     instance:
       hostname: discovery         # 指定该Eureka实例的主机名
     client:
       registerWithEureka: false
       fetchRegistry: false
       serviceUrl:
         defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/

   # 参考文档：http://projects.spring.io/spring-cloud/docs/1.0.3/spring-cloud.html#_standalone_mode
   # 参考文档：http://my.oschina.net/buwei/blog/618756
   ```

4. 启动工程后，访问：[http://discovery:8761/](http://discovery:8761/)，如下图。我们会发现此时还没有服务注册到Eureka上面。

   ![Eureka启动界面](images/eureka-no-instances.png)





## Eureka高可用

按照上文，我们即可构建出一个简单的注册中心（Eureka），我们发现，此时的Eureka是单点的，不适合于生产环境，那么如何实现Eureka的高可用呢？

1. 添加主机名：

   ```shell
   127.0.0.1 peer1 peer2
   ```

2. 修改application.yml

   ```yaml
   ---
   spring:
     profiles: peer1                                 # 指定profile=peer1
   server:
     port: 8761
   eureka:
     instance:
       hostname: peer1                               # 指定当profile=peer1时，主机名
     client:
       serviceUrl:
         defaultZone: http://peer2:8762/eureka/      # 将自己注册到peer2这个Eureka上面去

   ---
   spring:
     profiles: peer2
   server:
     port: 8762
   eureka:
     instance:
       hostname: peer2
     client:
       serviceUrl:
         defaultZone: http://peer1:8761/eureka/
   ```

3. 分别启动两个Eureka应用：

   ```shell
   java -jar microservice-discovery-eureka-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer1
   java -jar microservice-discovery-eureka-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer2
   ```

4. 访问`http://peer1:8761` ，我们会发现`registered-replicas` 中已经有`peer2` 节点了，同样地，访问`http://peer2:8762` ，也能发现其中的`registered-replicas`  有`peer1` 节点，如下图：

   ![Eureka 高可用](images/eureka-2.png)

5. 我们尝试将`peer2` 节点关闭，然后访问`http://peer1:8761` ，会发现此时peer2会被添加到`unavaliable-replicas` 一栏中。


注意：该示例中的`hostname` 并非必须的，如果不配置，默认将会使用IP进行查找



## 参考文档

> [http://cloud.spring.io/spring-cloud-static/Brixton.SR5/#spring-cloud-eureka-server](http://cloud.spring.io/spring-cloud-static/Brixton.SR5/#spring-cloud-eureka-server)



## 代码地址（任选其一）

> [http://git.oschina.net/itmuch/spring-cloud-study/tree/master/microservice-discovery-eureka](http://git.oschina.net/itmuch/spring-cloud-study/tree/master/microservice-discovery-eureka)
> [https://github.com/eacdy/spring-cloud-study/tree/master/microservice-discovery-eureka](https://github.com/eacdy/spring-cloud-study/tree/master/microservice-discovery-eureka)

